<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Loan DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body>
  <h2>Loan DApp</h2>

  <!-- Wallet -->
  <button onclick="connectWallet()">Connect Wallet</button>
  <p id="walletAddress">Not Connected</p>

  <hr>

  <!-- Offer Loan -->
  <h3>Offer Loan</h3>
  <input type="number" id="loanAmount" placeholder="Loan Amount (ETH)">
  <input type="number" id="interestRate" placeholder="Interest Rate (%)">
  <input type="text" id="docHash" placeholder="Document (any string)">
  <button onclick="offerLoan()">Offer Loan</button>

  <hr>

  <!-- Take Loan -->
  <h3>Take Loan</h3>
  <button onclick="takeLoan()">Take Loan</button>

  <hr>

  <!-- Repay Loan -->
  <h3>Repay Loan</h3>
  <input type="number" id="repayAmount" placeholder="Repay Amount (ETH)">
  <button onclick="repayLoan()">Repay Loan</button>

  <script>
    let web3;
    let contract;
    let account;

    const contractAddress = "0xC2e0620752E4115cA679d71Ad2c9ee63f2d046Fc";
    const contractABI = [ 
      {
        "inputs":[{"internalType":"uint256","name":"_interestRate","type":"uint256"},{"internalType":"bytes32","name":"_docHash","type":"bytes32"}],
        "name":"offerLoan",
        "outputs":[],
        "stateMutability":"payable",
        "type":"function"
      },
      {"inputs":[],"name":"repayLoan","outputs":[],"stateMutability":"payable","type":"function"},
      {"inputs":[],"name":"resetLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"bytes32","name":"_userDocHash","type":"bytes32"}],"name":"submitDocument","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"takeLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
      {"inputs":[],"name":"borrower","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"docSubmitted","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"documentHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"interestRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"lender","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"loanAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"loanOffered","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"loanRepaid","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"loanStartTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"loanTaken","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}
    ];

    // Connect wallet
    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        account = accounts[0];
        contract = new web3.eth.Contract(contractABI, contractAddress);
        document.getElementById("walletAddress").innerText = "Connected: " + account;
      } else {
        alert("Please install MetaMask");
      }
    }

    // Offer loan
    async function offerLoan() {
      const amount = document.getElementById("loanAmount").value;
      const rate = document.getElementById("interestRate").value;
      const docHashInput = document.getElementById("docHash").value;

      if (!amount || !rate || !docHashInput) {
        return alert("Please enter all fields");
      }

      // Convert string to bytes32
      const docHash = web3.utils.asciiToHex(docHashInput);

      try {
        await contract.methods.offerLoan(rate, docHash).send({
          from: account,
          value: web3.utils.toWei(amount, "ether")
        });
        alert("Loan offered successfully");
      } catch (err) {
        console.error(err);
        alert("Offer loan failed");
      }
    }

    // Take loan
    async function takeLoan() {
      try {
        await contract.methods.takeLoan().send({ from: account });
        alert("Loan taken successfully");
      } catch (err) {
        console.error(err);
        alert("Take loan failed");
      }
    }

    // Repay loan
    async function repayLoan() {
      const repayAmount = document.getElementById("repayAmount").value;
      if (!repayAmount) return alert("Enter repay amount");

      try {
        await contract.methods.repayLoan().send({
          from: account,
          value: web3.utils.toWei(repayAmount, "ether")
        });
        alert("Loan repaid successfully");
      } catch (err) {
        console.error(err);
        alert("Repay loan failed");
      }
    }
  </script>
</body>
</html>
