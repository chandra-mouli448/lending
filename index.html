<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>P2P Lending DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .toastBox { position: fixed; top: 20px; right: 20px; z-index: 1000; }
    .toast { margin: 5px; padding: 10px 15px; color: #fff; border-radius: 8px; }
    button { padding: 8px 12px; margin: 5px; cursor: pointer; }
  </style>
</head>
<body>

  <h1>Decentralized P2P Lending</h1>

  <!-- Wallet -->
  <button onclick="connectWallet()">Connect Wallet</button>
  <p id="walletAddress">Not Connected</p>

  <!-- Loan Offer -->
  <h2>Lender</h2>
  <input type="number" id="interestRate" placeholder="Interest Rate (%)"><br>
  <input type="number" id="loanAmount" placeholder="Loan Amount (ETH)"><br>
  <input type="file" id="lenderDoc"><br>
  <button onclick="offerLoan()">Offer Loan</button>

  <!-- Borrower -->
  <h2>Borrower</h2>
  <input type="file" id="borrowerDoc"><br>
  <button onclick="submitDocument()">Submit Document</button>
  <button onclick="takeLoan()">Take Loan</button>

  <!-- Repay -->
  <h2>Repay Loan</h2>
  <button onclick="repayLoan()">Repay</button>
  <p id="repayStatus"></p>
  <button onclick="resetLoanManually()">Manual Reset</button>

  <!-- Toasts -->
  <div id="toastBox" class="toastBox"></div>

  <script>
    let web3;
    let account;
    const contractAddress = "0xC2e0620752E4115cA679d71Ad2c9ee63f2d046Fc"; // <-- your deployed contract
    const contractABI = [
      {
        "inputs": [
          { "internalType": "uint256", "name": "rate", "type": "uint256" },
          { "internalType": "string", "name": "docHash", "type": "string" }
        ],
        "name": "offerLoan",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "takeLoan",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "repayLoan",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      }
    ];
    let contract;

    // Toast
    function showToast(message, type = "info") {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerText = message;
      if (type === "error") toast.style.backgroundColor = "#dc3545";
      if (type === "success") toast.style.backgroundColor = "#28a745";
      if (type === "info") toast.style.backgroundColor = "#007bff";
      document.getElementById("toastBox").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Connect Wallet
    async function connectWallet() {
      if (window.ethereum) {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          account = accounts[0];
          web3 = new Web3(window.ethereum);
          contract = new web3.eth.Contract(contractABI, contractAddress);
          document.getElementById("walletAddress").innerText = `Connected: ${account}`;
          showToast("✅ Wallet connected", "success");
        } catch (error) {
          console.error("Connection error:", error);
          showToast("❌ Wallet connection failed", "error");
        }
      } else {
        showToast("❌ Please install MetaMask", "error");
      }
    }

    // Auto detect account/chain change
    if (window.ethereum) {
      window.ethereum.on("accountsChanged", (accounts) => {
        account = accounts[0];
        document.getElementById("walletAddress").innerText = `Connected: ${account}`;
      });
      window.ethereum.on("chainChanged", () => {
        window.location.reload();
      });
    }

    // Offer Loan
    async function offerLoan() {
      const rate = document.getElementById("interestRate").value;
      const amount = document.getElementById("loanAmount").value;
      const file = document.getElementById("lenderDoc").files[0];
      if (!file) return showToast("Upload document", "error");
      const hash = await getFileHash(file);
      try {
        await contract.methods.offerLoan(rate, hash).send({ from: account, value: web3.utils.toWei(amount, 'ether') });
        showToast("Loan offered successfully", "success");
      } catch (err) {
        console.error(err);
        showToast("Loan offer failed", "error");
      }
    }

    // Submit Borrower Document
    async function submitDocument() {
      const file = document.getElementById("borrowerDoc").files[0];
      if (!file) return showToast("Upload borrower document", "error");
      const hash = await getFileHash(file);
      try {
        await contract.methods.submitDocument(hash).send({ from: account });
        showToast("Document submitted", "success");
      } catch (err) {
        console.error(err);
        showToast("Document submission failed", "error");
      }
    }

    // Take Loan
    async function takeLoan() {
      try {
        await contract.methods.takeLoan().send({ from: account });
        showToast("Loan taken successfully", "success");
      } catch (err) {
        console.error(err);
        showToast("Loan taking failed", "error");
      }
    }

    // Repay Loan
    async function repayLoan() {
      try {
        await contract.methods.repayLoan().send({ from: account, value: web3.utils.toWei("1", "ether") }); // example repayment
        document.getElementById("repayStatus").innerText = "✅ Repayment successful";
        showToast("Loan repaid", "success");
      } catch (err) {
        console.error("Repay failed:", err);
        document.getElementById("repayStatus").innerText = "❌ Repayment failed";
        showToast("Repayment failed", "error");
      }
    }

    // Reset Loan
    async function resetLoanManually() {
      try {
        await contract.methods.resetLoan().send({ from: account });
        document.getElementById("repayStatus").innerText = "Loan reset";
        showToast("Loan reset", "success");
      } catch (err) {
        console.error(err);
        showToast("Reset failed", "error");
      }
    }

    // File Hash (SHA-256)
    async function getFileHash(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async () => {
          try {
            const buffer = reader.result;
            const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = "0x" + hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
            resolve(hashHex);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }
  </script>
</body>
</html>
