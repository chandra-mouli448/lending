<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Decentralized Lending</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 5px; padding: 10px; cursor: pointer; }
    #walletAddress { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Decentralized Lending DApp</h2>

  <button onclick="connectWallet()">Connect Wallet</button>
  <p id="walletAddress">Not Connected</p>

  <hr>

  <h3>Offer Loan</h3>
  <input type="number" id="loanAmount" placeholder="Loan Amount in ETH">
  <input type="number" id="interestRate" placeholder="Interest Rate (%)">
  <input type="text" id="docHash" placeholder="Document Hash (bytes32)">
  <button onclick="offerLoan()">Offer Loan</button>

  <h3>Take Loan</h3>
  <button onclick="takeLoan()">Take Loan</button>

  <h3>Repay Loan</h3>
  <input type="number" id="repayAmount" placeholder="Repay Amount in ETH">
  <button onclick="repayLoan()">Repay Loan</button>

  <script>
    let web3;
    let contract;
    let account;

    const contractAddress = "0xC2e0620752E4115cA679d71Ad2c9ee63f2d046Fc";
    const contractABI = [
      {
        "inputs":[{"internalType":"uint256","name":"_interestRate","type":"uint256"},{"internalType":"bytes32","name":"_docHash","type":"bytes32"}],
        "name":"offerLoan",
        "outputs":[],
        "stateMutability":"payable",
        "type":"function"
      },
      {"inputs":[],"name":"repayLoan","outputs":[],"stateMutability":"payable","type":"function"},
      {"inputs":[],"name":"resetLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"bytes32","name":"_userDocHash","type":"bytes32"}],"name":"submitDocument","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"takeLoan","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
      {"inputs":[],"name":"borrower","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"docSubmitted","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"documentHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"interestRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"lender","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"loanAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"loanOffered","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"loanRepaid","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"loanStartTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"loanTaken","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}
    ];

    async function connectWallet() {
      if (window.ethereum) {
        try {
          const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
          account = accounts[0];
          web3 = new Web3(window.ethereum);
          contract = new web3.eth.Contract(contractABI, contractAddress);
          document.getElementById("walletAddress").innerText = `Connected: ${account}`;
        } catch (err) {
          console.error("Wallet connection failed:", err);
          alert("Wallet connection failed");
        }
      } else {
        alert("Please install MetaMask");
      }
    }

    async function offerLoan() {
      const amount = document.getElementById("loanAmount").value;
      const rate = document.getElementById("interestRate").value;
      const docHash = document.getElementById("docHash").value;

      if (!amount || !rate || !docHash) return alert("Please fill all fields");

      try {
        await contract.methods.offerLoan(rate, docHash).send({
          from: account,
          value: web3.utils.toWei(amount, "ether")
        });
        alert("Loan offered successfully");
      } catch (err) {
        console.error(err);
        alert("Offer loan failed");
      }
    }

    async function takeLoan() {
      try {
        await contract.methods.takeLoan().send({ from: account });
        alert("Loan taken successfully");
      } catch (err) {
        console.error(err);
        alert("Take loan failed");
      }
    }

    async function repayLoan() {
      const repayAmount = document.getElementById("repayAmount").value;
      if (!repayAmount) return alert("Enter repay amount");

      try {
        await contract.methods.repayLoan().send({
          from: account,
          value: web3.utils.toWei(repayAmount, "ether")
        });
        alert("Loan repaid successfully");
      } catch (err) {
        console.error(err);
        alert("Repay loan failed");
      }
    }

    // Auto-update if account/chain changes
    if (window.ethereum) {
      window.ethereum.on("accountsChanged", (accounts) => {
        account = accounts[0];
        document.getElementById("walletAddress").innerText = `Connected: ${account}`;
      });
      window.ethereum.on("chainChanged", () => {
        window.location.reload();
      });
    }
  </script>
</body>
</html>
