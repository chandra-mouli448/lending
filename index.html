<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P Lending DApp</title>
  <script src="https://unpkg.com/web3@1.10.0/dist/web3.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#222; color:white; font-family:sans-serif; padding:20px; }
    .container { max-width:500px; margin:auto; background:#333; padding:20px; border-radius:10px; }
    input,button { margin-top:10px; }
    .panel { display:none; }
    .panel.show { display:block; }
  </style>
</head>
<body>

<div class="container">
  <h2 class="text-center mb-4">üí∏ P2P Lending DApp</h2>

  <button class="btn btn-primary w-100" onclick="connectWallet()">üîó Connect Wallet</button>
  <p id="walletAddress" class="mt-2"></p>

  <div class="mt-3 text-center">
    <button class="btn btn-success me-2" onclick="showPanel('lender')">Lender Panel</button>
    <button class="btn btn-warning" onclick="showPanel('borrower')">Borrower Panel</button>
  </div>

  <!-- Lender Panel -->
  <div class="panel" id="lenderPanel">
    <h5 class="mt-4">üí∞ Lender Panel</h5>
    <input id="interestRate" class="form-control" placeholder="Interest Rate (%)">
    <input id="loanAmount" class="form-control" placeholder="Loan Amount (ETH)">
    <input type="file" id="lenderDoc" class="form-control">
    <button class="btn btn-success w-100" onclick="offerLoan()">Offer Loan</button>
  </div>

  <!-- Borrower Panel -->
  <div class="panel" id="borrowerPanel">
    <h5 class="mt-4">ü§ù Borrower Panel</h5>
    <input type="file" id="borrowerDoc" class="form-control">
    <button class="btn btn-info w-100 mt-2" onclick="submitDocument()">Submit Document</button>
    <button class="btn btn-warning w-100 mt-2" onclick="takeLoan()">Take Loan</button>
    <button class="btn btn-success w-100 mt-2" onclick="repayLoan()">Repay Loan</button>
    <p id="repayStatus" class="mt-2"></p>
  </div>
</div>

<script>
let web3;
let account;
let contract;

// ‚ö†Ô∏è Replace this with your actual contract
const contractAddress = "YOUR_CONTRACT_ADDRESS_HERE";
const contractABI = YOUR_CONTRACT_ABI_HERE;

function showPanel(type){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show'));
  document.getElementById(type+'Panel').classList.add('show');
}

async function connectWallet(){
  if(window.ethereum){
    await window.ethereum.request({ method:'eth_requestAccounts' });
    web3 = new Web3(window.ethereum);
    const accounts = await web3.eth.getAccounts();
    account = accounts[0];
    contract = new web3.eth.Contract(contractABI, contractAddress);
    document.getElementById('walletAddress').innerText = "‚úÖ Connected: " + account;
    alert("Wallet connected");
  } else {
    alert("MetaMask not installed!");
  }
}

async function getFileHash(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = async () => {
      const arrayBuffer = reader.result;
      const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = '0x'+hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
      resolve(hashHex);
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

async function offerLoan(){
  const rate = document.getElementById('interestRate').value;
  const amount = document.getElementById('loanAmount').value;
  const file = document.getElementById('lenderDoc').files[0];

  if(!file){ alert("Upload document"); return; }

  const hash = await getFileHash(file);
  try {
    await contract.methods.offerLoan(rate, hash).send({
      from: account,
      value: web3.utils.toWei(amount, 'ether'),
      gas: 300000
    });
    alert("‚úÖ Loan Offered Successfully");
  } catch (e) {
    alert("‚ùå Transaction Failed:\n" + (e.message || "Unknown error"));
  }
}

async function submitDocument(){
  const file = document.getElementById('borrowerDoc').files[0];
  if(!file){ alert("Upload document"); return; }

  const hash = await getFileHash(file);
  try{
    await contract.methods.submitDocument(hash).send({from:account});
    alert("üìÑ Document Submitted");
  }catch(e){
    alert("‚ùå Failed:\n" + (e.message || "Unknown error"));
  }
}

async function takeLoan(){
  try{
    await contract.methods.takeLoan().send({from:account, gas:300000});
    alert("üí∞ Loan Taken Successfully");
  }catch(e){
    alert("‚ùå Failed:\n" + (e.message || "Unknown error"));
  }
}

async function repayLoan(){
  try{
    const loanAmount = await contract.methods.loanAmount().call();
    const interestRate = await contract.methods.interestRate().call();
    const startTime = await contract.methods.loanStartTime().call();

    const now = Math.floor(Date.now()/1000);
    const months = Math.floor((now - startTime) / (30*24*3600));
    const interest = BigInt(loanAmount) * BigInt(interestRate) * BigInt(months+1) / 100n;
    const totalDue = BigInt(loanAmount) + interest;

    await contract.methods.repayLoan().send({
      from: account,
      value: totalDue.toString(),
      gas: 300000
    });

    document.getElementById('repayStatus').innerText = "‚úÖ Repayment done!";
    alert("‚úÖ Loan Repaid");
  }catch(e){
    alert("‚ùå Failed:\n" + (e.message || "Unknown error"));
  }
}
</script>

</body>
</html>
