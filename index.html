<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document-Backed Lending DApp</title>
  <!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Web3.js -->
<script src="https://unpkg.com/web3@1.10.0/dist/web3.min.js"></script>

  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
   /* Your existing CSS remains unchanged */
   /* ... (omitted for brevity) ... */
  </style>
</head>
<body>
  <button class="btn btn-dark dark-toggle" onclick="toggleDarkMode()">üåì Toggle Dark Mode</button>

  <div class="reset-section" id="resetSection">
    <button onclick="resetLoanManually()" class="btn btn-reset">
      <i class="fas fa-redo"></i> Reset Loan
    </button>
  </div>

  <button class="btn history-btn-fixed" onclick="showHistoryModal()">
    <i class="fas fa-history"></i> History
  </button>

  <div class="container py-5 px-4">
    <h2 class="title mb-4">üìú Document-Backed Lending DApp</h2>

    <lottie-player
      src="https://assets5.lottiefiles.com/packages/lf20_ydo1amjm.json"
      background="transparent"
      speed="1"
      style="width: 100px; height: 100px; margin: 0 auto;"
      loop
      autoplay>
    </lottie-player>

    <div class="wallet-section">
      <h5>üîå Wallet Connection</h5>
      <button class="btn btn-primary mb-2" onclick="connectWallet()">Connect Wallet</button>
      <p id="walletAddress" class="text-success" style="display: none;"></p>
    </div>

    <div class="action-buttons">
      <button class="action-btn" onclick="showPanel('lender')" id="lenderBtn">
        <i class="fas fa-hand-holding-usd"></i>
        Offer Loan
      </button>
      <button class="action-btn" onclick="showPanel('borrower')" id="borrowerBtn">
        <i class="fas fa-money-bill-wave"></i>
        Borrow Loan
      </button>
    </div>

    <!-- Lender Panel -->
    <div class="panel" id="lenderPanel">
      <h5>üí∞ Lender Panel</h5>
      <input id="interestRate" class="form-control mb-2" placeholder="Interest Rate (%)" type="number" min="0" step="any">
      <input id="loanAmount" class="form-control mb-2" placeholder="Loan Amount (in ETH)" type="number" min="0" step="any">
      <input type="file" id="lenderDoc" class="form-control mb-3">
      <button class="btn btn-success w-100" onclick="offerLoan()">Offer Loan</button>
    </div>

    <!-- Borrower Panel -->
    <div class="panel" id="borrowerPanel">
      <h5>üìÑ Borrower Panel</h5>
      <input type="file" id="borrowerDoc" class="form-control mb-3">
      <button class="btn btn-warning w-100 mb-2" onclick="submitDocument()">Submit Document</button>
      <button class="btn btn-primary w-100 mb-2" onclick="takeLoan()">Take Loan</button>
      <button class="btn btn-purple w-100 mb-2" onclick="repayLoan()">Repay Loan</button>
      <p id="repayStatus" class="mt-3 text-danger"></p>
    </div>
  </div>

  <div id="toastBox"></div>

  <!-- History Modal -->
  <div id="historyModal" class="modal-background" onclick="closeModal(event)">
    <div class="modal-box" id="modalContent">
      <h4>üìú Transaction History</h4>
      <ul id="historyList"></ul>
      <button class="btn btn-danger mt-3" onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    let currentPanel = null;

    // Show Panel Function
    function showPanel(type) {
      document.querySelectorAll('.panel').forEach(panel => {
        panel.classList.remove('show');
        setTimeout(() => {
          if (!panel.classList.contains('show')) {
            panel.style.display = 'none';
          }
        }, 300);
      });

      document.querySelectorAll('.action-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      setTimeout(() => {
        const panel = document.getElementById(type + 'Panel');
        const btn = document.getElementById(type + 'Btn');
        
        if (panel && btn) {
          panel.style.display = 'block';
          setTimeout(() => panel.classList.add('show'), 50);
          btn.classList.add('active');
          
          currentPanel = type;
          
          const resetSection = document.getElementById('resetSection');
          if (type === 'lender') {
            resetSection.classList.add('show');
          } else {
            resetSection.classList.remove('show');
          }
        }
      }, 300);
    }

    // Toggle Dark Mode
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
    }

    // Toast Notification
    function showToast(message, type = "info") {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerText = message;

      if (type === "error") toast.style.backgroundColor = "#dc3545";
      if (type === "success") toast.style.backgroundColor = "#28a745";

      document.getElementById("toastBox").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Blockchain and contract setup
    let web3;
    let account;
    const contractAddress = "0x1616bb92cD87643f3FCEfa1468C10Da5c3840f44";
    const contractABI =[ /* your ABI unchanged */ 
      // (Omitted here for brevity but keep your original ABI)
    ];

    let contract;

    async function connectWallet() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          account = accounts[0];
          web3 = new Web3(window.ethereum);
          contract = new web3.eth.Contract(contractABI, contractAddress);

          const lenderAddress = await contract.methods.lender().call();

          document.getElementById("walletAddress").style.display = "block";
          document.getElementById("walletAddress").innerText = "Connected: " + account;

          const resetSection = document.getElementById('resetSection');
          if (account.toLowerCase() === lenderAddress.toLowerCase()) {
            resetSection.classList.add('show');
          } else {
            resetSection.classList.remove('show');
          }

          showToast("Wallet connected!", "success");
        } catch (err) {
          console.error("Connection error:", err);
          showToast("Wallet connection failed!", "error");
        }
      } else {
        showToast("MetaMask not installed!", "error");
      }
    }

    async function offerLoan() {
      const rate = document.getElementById("interestRate").value;
      const amount = document.getElementById("loanAmount").value;
      const file = document.getElementById("lenderDoc").files[0];
      if (!file) return showToast("Please upload a document", "error");
      if (!rate || isNaN(rate) || rate <= 0) return showToast("Enter a valid interest rate", "error");
      if (!amount || isNaN(amount) || amount <= 0) return showToast("Enter a valid loan amount", "error");

      const hash = await getFileHash(file);
      try {
        await contract.methods.offerLoan(rate, hash).send({ from: account, value: web3.utils.toWei(amount, 'ether') });
        showToast("Loan offered successfully!", "success");
      } catch (err) {
        console.error(err);
        showToast("Failed to offer loan. Make sure the loan is reset and try again.", "error");
      }
    }

    async function submitDocument() {
      const file = document.getElementById("borrowerDoc").files[0];
      if (!file) return showToast("Upload the same document", "error");

      const hash = await getFileHash(file);
      try {
        await contract.methods.submitDocument(hash).send({ from: account });
        showToast("Document submitted!", "success");
      } catch (err) {
        console.error(err);
        showToast("Failed to submit document", "error");
      }
    }

    async function takeLoan() {
      try {
        await contract.methods.takeLoan().send({ from: account });
        showToast("Loan taken successfully!", "success");
      } catch (err) {
        console.error(err);
        showToast("Failed to take loan", "error");
      }
    }

    async function repayLoan() {
      try {
        const [loanAmount, interestRate, loanStartTime, lenderAddress] = await Promise.all([
          contract.methods.loanAmount().call(),
          contract.methods.interestRate().call(),
          contract.methods.loanStartTime().call(),
          contract.methods.lender().call()
        ]);

        const now = Math.floor(Date.now() / 1000);
        const elapsed = now - Number(loanStartTime);
        const monthsElapsed = Math.floor(elapsed / (30 * 24 * 60 * 60));

        const interest = (BigInt(loanAmount) * BigInt(interestRate) * BigInt(monthsElapsed + 1)) / 100n;
        const totalDue = BigInt(loanAmount) + interest;

        await contract.methods.repayLoan().send({ from: account, value: totalDue.toString() });

        document.getElementById("repayStatus").innerText = "‚úÖ Repayment successful. Resetting loan...";
        document.getElementById("repayStatus").classList.remove("text-danger");
        document.getElementById("repayStatus").classList.add("text-success");

        if (account.toLowerCase() === lenderAddress.toLowerCase()) {
          try {
            await contract.methods.resetLoan().send({ from: account });
            document.getElementById("repayStatus").innerText = "‚úÖ Loan repaid and reset. You can now start a new one.";
          } catch (resetError) {
            console.error("Reset failed:", resetError);
            document.getElementById("repayStatus").innerText = "Repayment done, but loan reset failed.";
          }
        } else {
          document.getElementById("repayStatus").innerText = "‚úÖ Repayment done. Lender must reset to start a new loan.";
        }

        showToast("Loan repaid successfully!", "success");
      } catch (err) {
        console.error("Repay failed:", err);
        document.getElementById("repayStatus").innerText = "‚ùå Failed to repay loan.";
        showToast("Failed to repay loan", "error");
      }
    }

    async function resetLoanManually() {
      try {
        const lenderAddress = await contract.methods.lender().call();
        if (account.toLowerCase() !== lenderAddress.toLowerCase()) {
          showToast("Only lender can reset the loan.", "error");
          return;
        }
        await contract.methods.resetLoan().send({ from: account });
        document.getElementById("repayStatus").innerText = "Loan reset manually by lender.";
        document.getElementById("repayStatus").classList.remove("text-danger");
        document.getElementById("repayStatus").classList.add("text-success");
        showToast("Loan reset successfully!", "success");
      } catch (err) {
        console.error(err);
        document.getElementById("repayStatus").innerText = "Manual reset failed.";
        showToast("Manual reset failed", "error");
      }
    }

    async function getFileHash(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async () => {
          try {
            const buffer = new Uint8Array(reader.result);
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = "0x" + hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            resolve(hashHex);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    async function showHistoryModal() {
      if (!contract) return showToast("Please connect wallet first.", "error");
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "Loading...";
      document.getElementById("historyModal").style.display = "flex";

      // If your contract doesn't emit events, skip fetching to avoid errors
      showToast("Event history feature requires contract events to be implemented.", "info");
      historyList.innerHTML = "‚ö†Ô∏è No event history available.";

      // Uncomment and adjust the following if events exist in your contract:
      /*
      const eventsToFetch = ["LoanOffered", "LoanTaken", "LoanRepaid"];
      let events = [];
      try {
        for (const eventName of eventsToFetch) {
          const past = await contract.getPastEvents(eventName, { fromBlock: 0, toBlock: "latest" });
          events.push(...past);
        }
        events.sort((a, b) => a.blockNumber - b.blockNumber);
        historyList.innerHTML = "";
        for (const ev of events) {
          const address = ev.returnValues["lender"] || ev.returnValues["borrower"] || ev.address;
          const type = ev.event;
          let color = "#3b82f6";
          if (type === "LoanTaken") color = "#f59e0b";
          if (type === "LoanRepaid") color = "#10b981";
          const li = document.createElement("li");
          li.innerHTML = `<span style="color:${color}; font-weight:600">${type}</span> by ${address}`;
          historyList.appendChild(li);
        }
      } catch (e) {
        console.error("Error fetching history:", e);
        historyList.innerHTML = "‚ùå Failed to load history.";
      }
      */
    }

    function closeModal(event) {
      if (!event || event.target.classList.contains("modal-background")) {
        document.getElementById("historyModal").style.display = "none";
      }
    }
  </script>
</body>
</html>
